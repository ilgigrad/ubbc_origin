services:
  web:
    container_name: ubbc-web
    build:
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
      - "443:443"
      - "80:80"
    volumes:
      - ./app:/var/www/html
      - ./app/vendor:/var/www/html/vendor
      - ./web/000-default.conf:/etc/apache2/sites-available/000-default.conf
      - ./certs:/etc/letsencrypt:ro
    depends_on:
      - db
      - grav
    networks:
      - ubbcnet


  db:
    image: mysql:8.0
    platform: linux/amd64
    container_name: ubbc-mysql
    restart: always
    environment:
      MYSQL_DATABASE: db15800_ubbc
      MYSQL_USER: db97064
      MYSQL_PASSWORD: Unfl@t&W1ld
      MYSQL_ROOT_PASSWORD: root&Unfl@t
      command: --default-authentication-plugin=mysql_native_password
    volumes:
      - ./db_data:/var/lib/mysql
      - ./db_dump:/docker-entrypoint-initdb.d
    ports:
      - "23306:3306"
    networks:
      - ubbcnet

  grav:
    image: linuxserver/grav:latest
    container_name: ubbc-grav
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - /home/david/Projects/ubbc.world/user:/config/www/user
    networks:
      - ubbcnet
    restart: unless-stopped

  certbot:
    image: certbot/certbot
    container_name: ubbc-certbot
    volumes:
      - ./certs:/etc/letsencrypt
      - ./app:/var/www/html
    command: certonly --webroot --webroot-path=/var/www/html --email david@ubbc.fr --agree-tos --no-eff-email -d ubbc.fr -d www.ubbc.fr
    depends_on:
      - web
    networks:
      - ubbcnet

networks:
  ubbcnet:
    name: ubbcnet
    external: true

volumes:
  certs:
